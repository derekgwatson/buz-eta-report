{% extends "layout.html" %}
{% block title %}Generating reportâ€¦{% endblock %}
{% block content %}
<div class="loading-container">
  <div class="loading-spinner">
    <div class="dot dot1"></div>
    <div class="dot dot2"></div>
    <div class="dot dot3"></div>
  </div>
  <h3>Generating your report</h3>
  <p id="status" class="loading-status">This may take a few moments</p>
</div>

<style>
  .loading-container {
    text-align: center;
    padding: 60px 20px;
  }
  .loading-container h3 {
    color: #333;
    font-weight: 500;
    margin-bottom: 8px;
  }
  .loading-status {
    color: #888;
    font-size: 0.95em;
  }
  .loading-spinner {
    display: flex;
    justify-content: center;
    gap: 8px;
    margin-bottom: 30px;
  }
  .dot {
    width: 12px;
    height: 12px;
    background-color: #4CAF50;
    border-radius: 50%;
    animation: bounce 1.4s ease-in-out infinite;
  }
  .dot2 { animation-delay: 0.16s; }
  .dot3 { animation-delay: 0.32s; }
  @keyframes bounce {
    0%, 80%, 100% { transform: scale(0.4); opacity: 0.4; }
    40% { transform: scale(1); opacity: 1; }
  }

  .alert { padding: 12px 16px; border-radius: 6px; margin-top: 20px; text-align: left; max-width: 500px; margin-left: auto; margin-right: auto; }
  .alert-danger { background-color: #fce4e4; border: 1px solid #f5c6c6; color: #8b1a1a; }
  .alert-warning { background-color: #fff8e1; border: 1px solid #ffe082; color: #7a6200; }
</style>

<script>
(function() {
  const jobId = "{{ job_id }}";
  const statusEl = document.getElementById('status');

  function htmlEscape(s){ return (s||"").toString().replace(/[&<>"']/g,m=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[m])); }

  async function poll() {
    try {
      const res = await fetch(`/jobs/${jobId}`, { headers: { "Accept": "application/json" }});
      if (!res.ok) throw new Error("status " + res.status);
      const data = await res.json();

      if (data.status === "completed") {
        window.location.replace(`/report/${jobId}`);
        return;
      }

      if (data.status === "failed") {
        document.querySelector('.loading-spinner').style.display = 'none';
        let html = `<div class="alert alert-danger">
          <strong>Unable to generate report</strong><br>
          ${htmlEscape(data.error||"An unexpected error occurred. Please try again or contact support.")}
        </div>`;
        if (data.traceback) {
          html += `<pre style="margin-top:12px;color:#888;font-size:0.85em;">${htmlEscape(data.traceback)}</pre>`;
        }
        statusEl.innerHTML = html;
        return;
      }
    } catch (e) {
      document.querySelector('.loading-spinner').style.display = 'none';
      statusEl.innerHTML = `<div class="alert alert-warning">
        <strong>Connection issue</strong><br>
        We're having trouble checking the status of your report. Please refresh this page.
      </div>`;
    }
    setTimeout(poll, 1200);
  }
  poll();
})();
</script>
{% endblock %}
