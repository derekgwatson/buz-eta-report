{% extends "layout.html" %}
{% block title %}Generating report…{% endblock %}
{% block content %}
<div class="container py-4">
  <h3 class="mb-3">Generating your report…</h3>
  <div id="status" class="text-muted mb-3" style="font-size: 1.1em;">Starting…</div>
  <div id="spinner" class="spinner-border text-primary" role="status">
    <span class="sr-only">Loading...</span>
  </div>
</div>

<style>
  .spinner-border {
    width: 3rem;
    height: 3rem;
    border-width: 0.3em;
  }
</style>

<script>
(function() {
  const jobId = "{{ job_id }}";
  const statusEl = document.getElementById('status');
  const spinnerEl = document.getElementById('spinner');

  function htmlEscape(s){ return (s||"").toString().replace(/[&<>"']/g,m=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[m])); }

  async function poll() {
    try {
      const res = await fetch(`/jobs/${jobId}`, { headers: { "Accept": "application/json" }});
      if (!res.ok) throw new Error("status " + res.status);
      const data = await res.json();

      // Show current status (just the latest log message)
      const logs = Array.isArray(data.log) ? data.log : [];
      const currentStatus = logs.length > 0 ? logs[logs.length - 1] : "Working…";
      statusEl.innerHTML = htmlEscape(currentStatus);

      if (data.status === "completed") {
        // Navigate to the final rendered report
        window.location.replace(`/report/${jobId}`);
        return;
      }

      if (data.status === "failed") {
        spinnerEl.style.display = 'none';
        let html = `<span class="text-danger">Failed: ${htmlEscape(data.error||"Unknown error")}</span>`;
        if (data.traceback) {
          html += `<pre class="mt-3 text-muted small">${htmlEscape(data.traceback)}</pre>`;
        }
        statusEl.innerHTML = html;
        return;
      }
    } catch (e) {
      spinnerEl.style.display = 'none';
      statusEl.innerHTML = `<span class="text-danger">Polling error: ${htmlEscape(e.message)}</span>`;
    }
    setTimeout(poll, 1200);
  }
  poll();
})();
</script>
{% endblock %}
